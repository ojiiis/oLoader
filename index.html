(async()=>{
  
 const loader = {
    head:[],
    body:[],
    script:[],
    load:(v)=>v,
 };
 let tempBody,tempHead,newB,blb = false;
const todo = [];
let loading = `<div id="preloader-wrapper" style="position:fixed;top:0;left:0;width:100%;height:100%;background-color:#ffffff;z-index:9999;display:flex;justify-content:center;align-items:center;opacity:1;transition:opacity 0.5s ease;">
    <div class="spinner" style="width:50px;height:50px;border:5px solid #ecf0f1;border-top-color:#3498db;border-radius:50%;animation:spin 1s linear infinite;"></div>
</div>`;
  const getContent = async(file,at,pos)=>{

    let data,url;
       try{
          new URL(file);
          url = file;
       }catch(e){
           url = window.location.protocol+'//'+window.location.host+'/'+file;
       }
       
       if(file.match(/[\n ]/)){
          data = file;
          
       }else{
     try{
         let req = await fetch(url);
        data = await req.text();
        if(req.status > 200)data = file;
      }catch(e){
         data = file;
      }
      
    }
         if(at == "script"){
             let tempSc = document.createElement('div');
          tempSc.innerHTML = data;
          for(let v of [...tempSc.querySelectorAll('script')]){
             if(v.src !== ""){
              let dd = await getContent(v.src);
              
              loader.script.push({data:dd,pos:'b'});
             }else{
               loader.script.push({data:v.textContent,pos:'b'});
             }
             v.remove();
          }
          return;
         }


       if(at == undefined){
          return data;
       }
       loader[at].push({data,pos});
      
  }

  const work = (type,file,pos) => {
      todo.push([file,type,pos]);
     
  }
  const parseBeginEnd = (type)=>{
     let headB = loader[type].filter((v)=>v.pos?.toLowerCase() == "b");
    let headE = loader[type].filter((v)=>v.pos?.toLowerCase() == "e");
       let e='',b='';
       headB.forEach((v)=>b+=v.data);
       headE.forEach((v)=>e+=v.data);
       return{begin:b,end:e}
  }
  const load = async(cb)=>{
     if(!blb)beforeloadFunc();
    await Promise.all(todo.map(v=>getContent(v[0],v[1],v[2])));
    newB.remove();
    let newBody,newHead;
    let [a,b,c,d,e] = [parseBeginEnd('body'),document.createElement('body'),parseBeginEnd('head'),parseBeginEnd('script'),document.createElement('script')];
    newBody = a.begin+ tempBody.innerHTML + a.end;
    b.innerHTML = newBody;
     e.textContent = loader.script.map((a)=>a.data).join('');
     b.append(e);
    document.documentElement.appendChild(b);
    newHead = c.begin+ document.getElementsByTagName("head")[0].innerHTML + c.end;
    document.head.innerHTML = newHead;
    if(typeof cb =="function")cb();
  }
  const beforeloadFunc = (file)=>{
   blb = true;
    if(file !== undefined){
   getContent(file).then(v=>{
      newB = document.createElement('body');
     newB.innerHTML = v;
      document.body = newB;
      
     });
     return;
     }
      newB = document.createElement('body');
     newB.innerHTML = `<style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .fade-out { opacity: 0 !important; visibility: hidden; }
</style>`+loading;

      document.documentElement.appendChild(newB);
}

   const head = (file,pos="e")=>work('head',file,pos);
   const body = (file,pos="e")=>work('body',file,pos);
   const script = (file,pos="e")=>work('script',file,pos);
   const beforeload = (f='')=>beforeloadFunc(f);
   const app = ()=>{
    tempBody = document.body;
    tempHead = document.head;
    document.body.remove();
    
    return {beforeload,head,body,script,load}
   }; 
  window.oLoader = app;

})();
